<!doctype html>
<meta charset="utf-8" />
<title>EMSC Overlay</title>
<style>
  html,body{height:100%;margin:0;background:transparent;overflow:hidden}
  /* 400x400 notification stage */
  #stage{
    position:fixed; top:0; left:0; width:400px; height:400px;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none; /* click-through on stream */
  }
  .card{
    width:360px; max-width:360px; /* keep inside 400px */
    color:#fff; background:rgba(10,10,10,.78);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px; padding:14px 16px;
    backdrop-filter: blur(6px);
    box-shadow:0 18px 48px rgba(0,0,0,.45);
    transform: translateY(-8px) scale(.98); opacity:0;
    animation: drop .35s ease-out forwards;
  }
  .title{font:600 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; letter-spacing:.2px}
  .meta{margin-top:6px; font: 13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; opacity:.95}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; margin-right:8px; background:#ff4d4f; color:#fff;}
  .m2{background:#ff7a45}.m3{background:#ffa940}.m4{background:#faad14}.m5{background:#fadb14;color:#111}
  .m6{background:#52c41a}.m7{background:#13c2c2}.m8{background:#722ed1}
  .close{position:absolute; top:10px; right:12px; opacity:.75; cursor:pointer; user-select:none; pointer-events:auto}
  .bar{height:3px; background:linear-gradient(90deg, #fff, transparent); opacity:.45; margin-top:10px}
  @keyframes drop{to{opacity:1; transform: translateY(0) scale(1)}}
  .fadeout{animation: fade .55s ease forwards}
  @keyframes fade{to{opacity:0; transform: translateY(-6px) scale(.98)}}
</style>
<div id="stage"></div>

<script>
/* ===== Config sync ===== */
const CONFIG_KEY = 'emscDockConfigV2';
const chan = new BroadcastChannel('emsc-quake');
const BOXES = {
  Turkey:{latMin:35,latMax:43,lonMin:25,lonMax:45},
  Greece:{latMin:34,latMax:42,lonMin:19,lonMax:29},
  Italy:{latMin:36,latMax:47,lonMin:6,lonMax:19},
  Bulgaria:{latMin:41,latMax:45,lonMin:22,lonMax:29},
  Romania:{latMin:43,latMax:49,lonMin:20,lonMax:30}
};
let cfg = {country:'Turkey', bbox:BOXES.Turkey, minMag:3.0, beep:true, soundUrl:''};

function loadCfg(){
  try{
    const s = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
    cfg.country = s.country ?? cfg.country;
    cfg.minMag  = (typeof s.minMag==='number') ? s.minMag : Number(s.minMag||cfg.minMag);
    cfg.beep    = (typeof s.beep==='boolean') ? s.beep : cfg.beep;
    cfg.soundUrl= s.soundUrl ?? cfg.soundUrl;
    cfg.bbox    = (s.country==='CustomBBox' && s.bbox) ? s.bbox : (BOXES[cfg.country]||BOXES.Turkey);
  }catch{}
}
loadCfg();
chan.onmessage = (e)=>{
  if(e.data?.type==='config:update'){ loadCfg(); }
  if(e.data?.type==='test'){ showAlert(makeTestProps(e.data.payload||{})); }
};
function makeTestProps(p){
  return {
    unid: 'TEST-'+Date.now(),
    mag: Number(p.mag ?? 5.5),
    magtype: p.magtype ?? 'Mw',
    lat: Number(p.lat ?? 39.9),
    lon: Number(p.lon ?? 32.8),
    depth: Number(p.depth ?? 10),
    time: new Date().toISOString(),
    flynn_region: p.flynn_region ?? 'TURKEY'
  };
}

/* ===== WebSocket ===== */
const WS_URL = 'wss://www.seismicportal.eu/standing_order/websocket';
let ws, retryTimer; const seen = new Set();
function connect(){
  clearTimeout(retryTimer);
  try{ ws && ws.close(); }catch{}
  ws = new WebSocket(WS_URL);
  ws.onclose = ()=> retryTimer = setTimeout(connect, 2000);
  ws.onmessage = (e)=>{
    try{
      const m = JSON.parse(e.data);
      const p = m?.data?.properties || {};
      if(!p.unid) return;
      if(seen.has(p.unid)) return;
      if(passesFilter(p)){ seen.add(p.unid); showAlert(p); }
    }catch{}
  };
}
function passesFilter(p){
  const b = cfg.bbox;
  const m = Number(cfg.minMag)||0;       // FIX: ensure numeric compare
  const mag = Number(p.mag)||0;
  const lat = Number(p.lat), lon = Number(p.lon);
  return (mag >= m && lat>=b.latMin && lat<=b.latMax && lon>=b.lonMin && lon<=b.lonMax);
}

/* ===== Sound ===== */
const defaultBeep = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAgP8AAP//AAAA';
function resolveUrlMaybeRelative(u){
  try { return new URL(u, document.location.href).href; } catch { return u; }
}
function getSoundUrl(){
  const s = (cfg.soundUrl||'').trim();
  return s ? resolveUrlMaybeRelative(s) : defaultBeep;
}
function playBeep(){
  if(!cfg.beep) return;
  const a = new Audio(getSoundUrl());
  a.play().catch(()=>{ /* In normal browsers autoplay may block; OBS allows. */ });
}

/* ===== UI ===== */
const stage = document.getElementById('stage');
function magClass(m){
  if(m>=8) return 'm8'; if(m>=7) return 'm7'; if(m>=6) return 'm6';
  if(m>=5) return 'm5'; if(m>=4) return 'm4'; if(m>=3) return 'm3'; return 'm2';
}
function showAlert(p){
  playBeep();
  const el = document.createElement('div');
  el.className = 'card';
  const when = new Date(p.time).toLocaleString();
  const mag = Number(p.mag||0);
  const badge = `<span class="badge ${magClass(mag)}">M${mag.toFixed(1)}</span>`;
  const title = `${badge} ${p.flynn_region || 'Region'} • ${p.depth ?? '?'} km`;
  const meta  = `${when}<br>(${Number(p.lat).toFixed(2)}, ${Number(p.lon).toFixed(2)}) ${p.magtype? '• '+p.magtype:''}`;
  el.innerHTML = `
    <div class="title">${title}<span class="close" title="dismiss">✕</span></div>
    <div class="meta">${meta}</div>
    <div class="bar"></div>
  `;
  el.querySelector('.close').onclick = ()=> dismiss(el);
  stage.innerHTML = '';            // only one card visible at a time inside 400x400
  stage.appendChild(el);
  const keep = mag>=6 ? 16000 : mag>=5 ? 12000 : 9000;
  setTimeout(()=> dismiss(el), keep);
}
function dismiss(el){
  if(!el) return;
  el.classList.add('fadeout');
  setTimeout(()=>{ if(el.parentNode===stage) stage.removeChild(el); }, 540);
}

/* boot */
connect();
</script>
